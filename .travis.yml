language: cpp

os: linux

dist: trusty
sudo: enabled

cache:
  - apt

before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -qq --yes libmysqlclient-dev
  - sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
  - sudo apt-get update -qq
  - sudo apt-get install -qq --yes gcc-5 g++-5
  - sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-5 60 --slave /usr/bin/g++ g++ /usr/bin/g++-5

install:
  - sudo wget https://cmake.org/files/v3.7/cmake-3.7.2.tar.gz
  - tar -xf cmake-3.7.2.tar.gz
  - cd cmake-3.7.2
  - sudo ./configure
  - sudo make && sudo make install

  - sudo sudo apt-get install libgtest-dev
  - cd /usr/src/gtest
  - sudo cmake .
  - sudo make
  - sudo cp *.a /usr/lib

  - sudo wget https://pocoproject.org/releases/poco-1.8.1/poco-1.8.1-all.tar.gz
  - sudo tar -xf poco-1.8.1-all.tar.gz
  - cd poco-1.8.1-all
  - sudo ./configure --no-tests --no-samples --omit=MongoDB,Data/ODBC,Data/SQLite,PDF,CppParser,Crypto,NetSSL_OpenSSL,CppUnit,PageCompiler
  - sudo make && sudo make install

services:
  - mysql

notifications:
    email:
      on_success: never  # default: change
      on_failure: always # default: always

before_script:
  # DBMS Settings
  - mysql -e "CREATE USER 'ci_environment'@'localhost' IDENTIFIED BY 'abc12345'; GRANT ALL ON *.* TO 'ci_environment'@'localhost'";

  - if test -e "/usr/share/ant/lib/ant-jsch.jar"; then
      sudo rm "/usr/share/ant/lib/ant-jsch.jar"; fi

  - ant -propertyfile ci.properties create_schema
  - ant -propertyfile ci.properties init_schema

script:
  - cmake .
  - make -s -j2

after_script:
  - ant -propertyfile ci.properties drop_schema